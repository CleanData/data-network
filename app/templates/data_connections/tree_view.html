{% extends "base.html" %}
{% block title %}Clean.Data.{% endblock %}

{% block libs %}
	<script type="text/javascript" src="/static/user/js/d3.v3.min.js"></script>
	<link type="text/css" href="/static/user/css/map_style.css" rel="stylesheet" />
	<script type="text/javascript" src="/static/user/js/testData.js"></script>

	<style>

.node circle, .node_d circle, .node_s circle {
  fill: #fff;
  stroke: steelblue;
  stroke-width: 1.5px;
}

.node, .node_s, .node_d {
  font: 10px sans-serif;
}

.link, .link_d, .link_s {
  fill: none;
  stroke: #ccc;
  stroke-width: 1.5px;
}

</style>
<script>

// can specify source or derivative
// builds a json along the lines of {"name": "zipcodes GeoJSON","children": [{"name": "Energy Zip","size":120},{"name": "VisioNYC","size":120},{"name":"Spread of the West Nile Virus","size":120}]}

var sourceTree={"details":{},"children":[]};
var derivativeTree={"details":{},"children":[]};
function populateTree(tree_in,direction){
	// first get the base json for the object
	tree_in.details={};
	tree_in.children=[];
	
	$.get('/api/v1/dataset/97/?format=json', function(data) {
			tree_in.details=data;
			// using closures we should be able to pre-populate this and create the empty nodes.
			numChildren=data[direction].length;
			 
			for(child in data[direction]){
				$.get(data[direction][child],function(child_data){tree_in.children.push({
																			"details":child_data,"children":[]
																		});plotMap();})
			}
		});
}

var graph, width, height, cluster, manager_s, manager_d, diagonal, diagonal_inv = null;
var i=0;

var counter=0;

function initGraph(){
	width = 800;
	height = 400;
	
	cluster = d3.layout.cluster()
	    .size([height, (width)/2.-160]);
	
	/*manager_d = d3.layout.cluster()
	    .size([height, (width)/2.-160]);*/
	
	diagonal = d3.svg.diagonal()
	    .projection(function(d) {return [d.y+width/2., d.x]; });
	
	diagonal_inv = d3.svg.diagonal()
	    .projection(function(d) { return [width/2.-d.y, d.x]; });
	
	graph = d3.select("#data_map").append("svg:svg")
	    .attr("width", width)
	    .attr("height", height)
	  .append("svg:g");

	plotMap();
}


function plotMap(){
	trees={"s":sourceTree,"d":derivativeTree};
for(dir in trees){
  tree=trees[dir];

  var nodes = cluster.nodes(tree),
      links = cluster.links(nodes);
  
  var node = graph.selectAll(".node_"+dir)
      .data(nodes, function(d) { return d.id || (d.id = ++i); });

  var nodeEnter = node.enter().append("g")
      .attr("class", "node_"+dir)
      .attr("transform", function(d) { 
	      if(dir=="s"){
		      return "translate(" + (width/2.-tree.y) + "," + (tree.x) + ")";}
	      else{
	      	  return "translate(" + (width/2.+tree.y) + "," + (tree.x) + ")";}
       });
      //.on("click", function(d) { toggle(d); update(d); });

  nodeEnter.append("svg:circle")
      .attr("r", 1e-6)
      .style("fill", "#fff");

  nodeEnter.append("text")
      .attr("dx", 0)
      .attr("dy", 15)
      .style("text-anchor", "middle")
      .text(function(d,i) { if(dir="s" || i>0){return d.details.name;} })
	  .style("fill-opacity", 1e-6);

  console.log(dir);
  console.log(tree);
  var nodeUpdate = node.transition()													// update
      .duration(1000)
      .attr("transform", function(d) { 
      		if(dir=="s"){
	      		console.log("In the source tree");
	      		console.log("translate(" + (width/2.-d.y) + "," + d.x + ")");
	      		return "translate(" + (width/2.-d.y) + "," + d.x + ")";} 
      		else{
				console.log("In the derivative tree");
				console.log("translate(" + (width/2.+d.y) + "," + d.x + ")");
				return "translate(" + (width/2.+d.y) + "," + d.x + ")";} 
  		})

  nodeUpdate.select("circle")
      .attr("r", 4.5)
      .style("fill", function(d) { return "#fff"; });

  nodeUpdate.select("text")
      .style("fill-opacity", 1);

  var nodeExit = node.exit().transition()
      .duration(1000)
      .attr("transform", function(d) { 
      			if(dir=="s"){return "translate(" + (width/2.-tree.y) + "," + (tree.x) + ")"; }
      			else{return "translate(" + (width/2.+tree.y) + "," + (tree.x) + ")"; }
      		})
      .remove();

  nodeExit.select("circle")
      .attr("r", 1e-6);

  nodeExit.select("text")
      .style("fill-opacity", 1e-6);


  // Update the linksâ€¦
  var link = graph.selectAll(".link_"+dir)
      .data(links, function(d) { return d.target.id; });

  // Enter any new links at the parent's previous position.
  var linkEnter=link.enter().insert("svg:path", "g")
      .attr("class", "link_"+dir)
      .attr("d", function(d) {
      	if(dir=="s"){
		    //var o = {x: (width/2.-tree.x), y: tree.y};
	        var o = {x: (height/2.), y: 0};
	        return diagonal_inv({source: o, target: o});
	        }
       else{
		        //var o = {x: (width/2.+tree.x), y: tree.y};
	        //var o = {x: (height/2.), y: (width/2.)};
	        var o = {x: (height/2.), y: 0};
	        return diagonal_inv({source: o, target: o});
	       }
      })

  if(dir=="s"){
	linkEnter.transition()
      .duration(1000)
      .attr("d", diagonal_inv);

	  // Transition links to their new position.
	  link.transition()
	      .duration(1000)
	      .attr("d", diagonal_inv);
  }
  else{
	linkEnter.transition()
      .duration(1000)
      .attr("d", diagonal);

	  // Transition links to their new position.
	  link.transition()
	      .duration(1000)
	      .attr("d", diagonal);
  }
  //continue;

  // Transition exiting nodes to the parent's new position.
  
  link.exit().transition()
      .duration(1000)
      .attr("d", function(d) {
		  if(dir=="d"){
		        //var o = {x: (width/2.-tree.x), y: tree.y};
		        var o = {x: (width/2.), y: 0};
		        return diagonal_inv({source: o, target: o});
	        }
		  else{
  		        //var o = {x: (width/2.+tree.x), y: tree.y};
		        var o = {x: (width/2.), y: 0};
		        return diagonal({source: o, target: o});
		  }
      })
      .remove();

	  /*
  var node_d = graph.selectAll(".node_d")
      .data(nodes_d, function(d) { return d.id || (d.id = ++i); })
//      .data(nodes_d)
    .enter().append("g")
      .attr("class", "node_d")
      .attr("transform", function(d) { return "translate(" + (width/2.+d.y) + "," + d.x + ")"; })

  node_d.append("circle")
      .attr("r", 4.5);

  node_d.append("text")
      .attr("dx", 0)
      .attr("dy", 15)
      .style("text-anchor", "middle")
      .text(function(d) { return d.details.name; });
      */
  /*node_s.append("text")
      .attr("dx", 0)
      .attr("dy", 15)
      .style("text-anchor", "middle")
      .text(function(d,i) { if(i>0){return d.details.name;} });*/

d3.select(self.frameElement).style("height", height + "px");


  nodes.forEach(function(d) {
    d.x0 = d.x;
    d.y0 = d.y;
  });

  }
}

function updateMap(){
	populateTree(sourceTree,"sources");
	populateTree(derivativeTree,"derivatives");
}
</script>
{% endblock %}

{% block onload %}
  onload=initGraph();updateMap();
{% endblock %}

{% block content %}

<div class="container">
	<div class="row-fluid">
		<div class="span3" id="sidebar">
			<div><h4><span id="dataset_name">Electricity Use Normalised by Household</span></h4></div>
			<div>Manager: <span id="dataset_owner"><a ref="users/jonroberts">Jonathan Roberts</a></span></div>
			<div>Contributors: <span id="dataset_contributors"><a href="users/jeffallen">Jeff Allen</a>, <a href="users/ronniejansson">Ronnie Jansson</a></span></div>
			<div>Location: <span id="dataset_url"><a href="http://www.github.com/jonroberts/zipcodegrid">EnergyZip Repository</a></span></div>
			<div>License: <span id="dataset_license"><a href="datacommons.org">Open Data</a></span></div>
			<div>Format: <span id="dataset_format"><a href="http://json.org">JSON</a></span></div>
			<div>Catalog: <span id="dataset_catalog">None</span></div>
			<div>Date Created: <span id="dataset_date_created">12th May 2013</span></div>
			<div>Last Edited: <span id="dataset_last_edited">23rd June 2013</span></div>
			<div>Sources:</div>
			<ul id="dataset_sources">
				<li><a href="#NYC-Zipcode-JSON">NYC Zipcode JSON</a></li>
				<li><a href="#2010-Census-Households">2010 Census - Households</a></li>
				<li><a href="#2010-Census-Population">2010 Census - Population</a></li>
				<li><a href="#Electric-Consumption-by-Zipcode-2010">Electric Consumption by Zipcode - 2010</a></li>
				<li><a href="#Retail-Sales-Of-Electricity-Monthly">Retail Sales of Electricity - Monthly</a></li>
			</ul>
			<div>Derivatives</div>
			<ul id="dataset_sources">
				<li>None</li>
			</ul>
			<hr/>
			<p>Datasets often paired with this:</p>
			<ul>
				<li>Solar energy coverage</li>
				<li>...</li>
			</ul>
		</div>
		<div class="span9" id="data_map"></div>
	</div>
</div>

{% endblock %}


























